---
- hosts: localhost
  become: yes
  become_user: root
  vars:
    ansible_python_interpreter: /usr/bin/python3
    local_username: user
    git_username: radtkedev
    git_email: mail@radtke.dev
    git_default_branch: master 
  tasks:
    - name: Reduce GRUB timeout
      register: grub_timeout
      lineinfile:
        path: /etc/default/grub
        regexp: "^GRUB_TIMEOUT="
        line: "GRUB_TIMEOUT=1"

    - name: Silence GRUB boot
      register: grub_cmdline
      lineinfile:
        path: /etc/default/grub
        regexp: "^GRUB_CMDLINE_LINUX="
        line: "GRUB_CMDLINE_LINUX=\"quiet rd.plymouth=0 plymouth.enable=0 loglevel=3\""

    - name: Update GRUB
      when: grub_timeout.changed or grub_cmdline.changed
      shell: "grub2-mkconfig -o /boot/efi/EFI/fedora/grub.cfg"

    - name: Set console font and keymap
      ansible.builtin.copy:
        dest: /etc/vconsole.conf
        content: |
          KEYMAP="de"
          FONT="ter-i16n"

    - name: Configure chrony NTP
      register: chrony
      ansible.builtin.copy:
        dest: /etc/chrony.conf
        content: |
          pool time.cloudflare.com iburst nts
          driftfile /var/lib/chrony/drift
          makestep 1.0 3
          rtcsync
          keyfile /etc/chrony.keys
          ntsdumpdir /var/lib/chrony
          leapsectz right/UTC
          logdir /var/log/chrony

    - name: Restart chrony
      when: chrony.changed
      ansible.builtin.service:
        name: chronyd
        state: restarted

    - name: Set up autologin (1/2)
      ansible.builtin.file:
        name: /etc/systemd/system/getty@tty1.service.d
        state: directory

    - name: Set up autologin (2/2)
      ansible.builtin.copy:
        dest: /etc/systemd/system/getty@tty1.service.d/override.conf
        content: |
          [Service]
          ExecStart=
          ExecStart=-/sbin/agetty --skip-login --nonewline --noissue --autologin {{ local_username }} --noclear %I $TERM

    - name: Remove last login information
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        content: ""
        dest: "/home/{{ local_username }}/.hushlogin"

    - name: Configure dnf
      ansible.builtin.copy:
        dest: /etc/dnf.conf
        content: |
          [main]
          gpgcheck=1
          installonly_limit=3
          clean_requirements_on_remove=True
          best=False
          skip_if_unavailable=True
          max_parallel_downloads=10
          deltarpm=true

    - name: Import RPM Fusion Free key
      rpm_key:
        state: present
        key: https://rpmfusion.org/keys?action=AttachFile&do=get&target=RPM-GPG-KEY-rpmfusion-free-fedora-2020

    - name: Enable RPM Fusion Free repository
      dnf:
        name: "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_distribution_major_version }}.noarch.rpm"
        state: present

    - name: Update all packages
      dnf:
        name: "*"
        state: latest
        update_cache: true

    - name: Install system utilities
      dnf:
        name: 
          - htop
          - ImageMagick
          - zip
          - net-tools
          - bind-utils
          - pwgen
          - qrencode 
          - traceroute
          - whois
          - neovim
          - terminus-fonts
          - terminus-fonts-console
        state: present

    - name: Install desktop applications
      dnf:
        name:
          - chromium
          - mpv
          - remmina
          - weechat
        state: present

    - name: Install desktop environment
      dnf:
        name:
          - i3
          - i3blocks
          - xorg-x11-server-Xorg
          - xorg-x11-xinit
          - xinput
          - xkill
          - xsel
          - xrdb
          - xclip
          - xprop
          - setxkbmap
          - dmenu
          - picom
          - gxkb
          - dbus-x11
          - dunst
          - nautilus
          - arc-theme
          - papirus-icon-theme
        state: present

    - name: Install media tools
      dnf:
        name:
          - volumeicon
          - pavucontrol
          - playerctl
          - ffmpeg
        state: present

    - name: Install disk and networking utilities
      dnf:
        name:
          - NetworkManager
          - NetworkManager-openconnect
          - NetworkManager-openconnect-gnome
          - udiskie
        state: present

    - name: Setup client ssh folder
      become_user: "{{ local_username }}"
      ansible.builtin.file:
        path: "/home/{{ local_username }}/.ssh"
        state: directory
        mode: 0700

    - name: Set git username
      become_user: "{{ local_username }}"
      git_config:
        name: user.name
        value: "{{ git_username }}"
        scope: global

    - name: Set git email
      become_user: "{{ local_username }}"
      git_config:
        name: user.email
        value: "{{ git_email }}"
        scope: global

    - name: Setup git default branch
      become_user: "{{ local_username }}"
      git_config:
        name: init.defaultBranch
        value: "{{ git_default_branch }}"
        scope: global

    - name: Set up .bashrc
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        src: .bashrc
        dest: /home/{{ local_username }}/.bashrc

    - name: Set up .bash_profile
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        src: .bash_profile
        dest: /home/{{ local_username }}/.bash_profile

    - name: Set up .xinitrc
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        src: .xinitrc
        dest: /home/{{ local_username }}/.xinitrc

    - name: Set up .Xresources
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        src: .Xresources
        dest: /home/{{ local_username }}/.Xresources

    - name: Set up configuration folder
      become_user: "{{ local_username }}"
      ansible.builtin.file:
        name: /home/{{ local_username }}/.config
        state: directory

    - name: Set up i3 folder
      become_user: "{{ local_username }}"
      ansible.builtin.file:
        name: /home/{{ local_username }}/.config/i3
        state: directory

    - name: Set up i3 config
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        src: .config/i3/config
        dest: /home/{{ local_username }}/.config/i3/config

    - name: Set up i3blocks folder
      become_user: "{{ local_username }}"
      ansible.builtin.file:
        name: /home/{{ local_username }}/.config/i3blocks
        state: directory

    - name: Set up i3blocks config
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        src: .config/i3blocks/config
        dest: /home/{{ local_username }}/.config/i3blocks/config

    - name: Set up dunst folder
      become_user: "{{ local_username }}"
      ansible.builtin.file:
        name: /home/{{ local_username }}/.config/dunst
        state: directory

    - name: Set up dunst config
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        src: .config/dunst/dunstrc
        dest: /home/{{ local_username }}/.config/dunst/dunstrc

    - name: Set up remmina folder
      become_user: "{{ local_username }}"
      ansible.builtin.file:
        name: /home/{{ local_username }}/.config/remmina
        state: directory

    - name: Set up remmina config
      become_user: "{{ local_username }}"
      ansible.builtin.copy:
        src: .config/remmina/remmina.pref
        dest: /home/{{ local_username }}/.config/remmina/remmina.pref
